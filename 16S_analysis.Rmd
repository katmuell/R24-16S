---
title: "R24-16S"
author: "Katherine Mueller"
date: "10/23/2020"
output:
  word_document: default
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(phyloseq)
library(readr)
library(readxl)
library(dplyr)
library(ggplot2)
library(cowplot)
```

## Analysis of Interim Samples
Samples submitted by Brad in 2019

Merge ASV count and taxonomy files
```{r, eval=FALSE}
otu_file <- "C:/Users/katmu/Dropbox/Valdivia Lab/Projects/Clinical Isolates/Data/Data_for_analysis/Community_Analysis/second_biom/2020-10-16_update/otu-table.txt"
taxonomy_file <- "C:/Users/katmu/Dropbox/Valdivia Lab/Projects/Clinical Isolates/Data/Data_for_analysis/Community_Analysis/second_biom/2020-10-16_update/taxonomy.tsv"

otu_table <- read.table(file = biom_file, header = TRUE)
tax <- read.table(file = taxonomy_file, sep = '\t', header = TRUE)
merged <- merge(otu_table, tax, by.x = c("OTUID"), by.y = c("OTUID"))
write.table(merged, file = "C:/Users/katmu/Dropbox/Valdivia Lab/Projects/Clinical Isolates/Data/Data_for_analysis/Community_Analysis/second_biom/2020-10-16_update/combined_otu_tax.txt", sep = '\t', col.names = TRUE, row.names = FALSE)
```
The resulting file was then used to create the otu and taxonomy files used in later steps. For ASV, I copied the OTU and count data into a new csv file. For taxonomy, I copied the OTU and taxon data into a new csv file. The taxon data was then split into Kindom, Phylum, etc. using the text-to-columns option in Excel.

Load files into phyloseq
```{r}
otu_matrix_file <- "C:/Users/katmu/Dropbox/Valdivia Lab/Projects/Clinical Isolates/Data/Data_for_analysis/Community_Analysis/second_biom/2020-10-16_update/otu-matrix.csv"
taxonomy_matrix_file <- "C:/Users/katmu/Dropbox/Valdivia Lab/Projects/Clinical Isolates/Data/Data_for_analysis/Community_Analysis/second_biom/2020-10-16_update/taxonomy-matrix.csv"
map_file <- "C:/Users/katmu/Dropbox/Valdivia Lab/Projects/Clinical Isolates/Data/Data_for_analysis/Community_Analysis/second_biom/sample-metadata.txt"

otu_matrix <- read.csv(otu_matrix_file, row.names = 1)
otu_matrix <- as.matrix(otu_matrix)

taxonomy_matrix <- read.csv(taxonomy_matrix_file, row.names = 1)
taxonomy_matrix <- as.matrix(taxonomy_matrix)

metadata <- read_delim(map_file, "\t", escape_double = FALSE, trim_ws = TRUE)
meta_df <- metadata %>% as.data.frame()
row.names(meta_df) <- metadata$SampleID
```

Import as phyloseq objects and merge into one
```{r}
otu <- otu_table(otu_matrix, taxa_are_rows = TRUE)
tax <- tax_table(taxonomy_matrix)
meta <- sample_data(meta_df)

physeq <- phyloseq(otu, tax, meta)
physeq
```

Set up subsets for analysis
```{r}
#At first, I wanted stool samples with matching Akkermansia isolates
#verruco_percent <- "C:/Users/katmu/Dropbox/Valdivia Lab/Projects/Clinical #Isolates/Data/Data_for_analysis/Community_Analysis/second_biom/2020-10-16_update/verruco_percent.xlsx"

#isolates <- read_excel(verruco_percent)
#samples_with_isolates <- isolates$Isolate

#isolate_subset <- subset_samples(physeq, SampleID %in% samples_with_isolates)

#Now I want stool samples of patients with Akk isolates at any timepoint
human_subjects_details <- "C:/Users/katmu/Dropbox/Valdivia Lab/Projects/Clinical Isolates/Data/Data_for_analysis/Community_Analysis/HumanSubjectsAkkermansia_KMupdate.xlsx"
patients_with_isolates <- read_excel(human_subjects_details)
patient_list <- patients_with_isolates$IND
patient_list <- c(patient_list, "Brad")

isolate_subset <- subset_samples(physeq, Patient %in% patient_list)

#Convert abundance counts to percentages. Provided by Jay.
isolate_subset_perc <- transform_sample_counts(isolate_subset, function(x) 100 * x/sum(x))

baseline <- subset_samples(isolate_subset_perc, Visit_number == 1)
endpoint <- subset_samples(isolate_subset_perc, Visit_number == 5)

control <- subset_samples(baseline, Treatment == "control")
base_obese <- subset_samples(baseline, Treatment != "control")
end_obese <- subset_samples(endpoint, Treatment != "control")
```

Count how many samples are in our categories of interest
```{r}
length(sample_names(control))
length(sample_names(base_obese))
length(sample_names(end_obese))
```

Calculate top 20 taxa in samples. Provided by Jay.
```{r}
Calc.Top20 <- function(subset) {
  top_otus <- names(sort(taxa_sums(subset), decreasing = TRUE))[1:20]
  subset_top20 <- prune_taxa(top_otus, subset)
  
  return(subset_top20)
}
```

Plot top 20 OTUs and color by phylum. Provided by Jay.
```{r}
control_top20 <- Calc.Top20(control)
control_plot <- plot_bar(control_top20, x = "Patient", fill = "Phylum") +
  geom_bar(stat = "identity", position = "stack", size = 0) +
  labs(title = "Controls")

base_obese_top20 <- Calc.Top20(base_obese)
base_obese_plot <- plot_bar(base_obese_top20, x = "Patient", fill = "Phylum") +
  geom_bar(stat = "identity", position = "stack", size = 0) +
  labs(title = "Base Obese")

end_obese_top20 <- Calc.Top20(end_obese)
end_obese_plot <- plot_bar(end_obese_top20, x = "Patient", fill = "Phylum") +
  geom_bar(stat = "identity", position = "stack", size = 0) +
  labs(title = "End Obese")

plot_grid(control_plot, base_obese_plot, end_obese_plot, labels = c('A', 'B', 'C'))
```

```{r}
begin_end <- subset_samples(isolate_subset_perc, Visit_number %in% c(1, 5))
begin_end_top20 <- Calc.Top20(begin_end)

begin_end_plot <- barplot <- plot_bar(begin_end_top20, x = "Visit_number", fill = "Phylum") +
  geom_bar(stat = "identity", position = "stack", size = 0) +
  facet_wrap(~ Patient) +
labs(title = "Start and Endpoints by Patient")
begin_end_plot
```


Plot top 20 OTUs and color by family. Requested for the R24 group.
```{r}
Calc.Top20.fam <- function(subset, graphtitle) {
  top_otus <- names(sort(taxa_sums(subset), decreasing = TRUE))[1:20]
  subset_top20 <- prune_taxa(top_otus, subset)
  barplot <- plot_bar(subset_top20, x = "SampleID", fill = "Family") +
    geom_bar(stat = "identity", position = "stack", size = 0) +
    scale_fill_brewer(palette = "Paired") +
    labs(title = graphtitle)
  
  return(barplot)
}

complete_perc <- transform_sample_counts(physeq, function(x) 100 * x/sum(x))
complete_plot <- Calc.Top20.fam(complete_perc, "Interim Samples")
complete_plot
```

## Analysis of Recent Samples
Samples submitted by Holly in 2020

```{r}

```

