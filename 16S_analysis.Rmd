---
title: "R24-16S"
author: "Katherine Mueller"
date: "10/23/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(phyloseq)
library(readr)
library(readxl)
library(dplyr)
library(ggplot2)
library(cowplot)
```

Merge ASV count and taxonomy files
```{r}
otu_file <- "C:/Users/katmu/Dropbox/Valdivia Lab/Projects/Clinical Isolates/Data/Data_for_analysis/Community_Analysis/second_biom/2020-10-16_update/otu-table.txt"
taxonomy_file <- "C:/Users/katmu/Dropbox/Valdivia Lab/Projects/Clinical Isolates/Data/Data_for_analysis/Community_Analysis/second_biom/2020-10-16_update/taxonomy.tsv"

otu_table <- read.table(file = biom_file, header = TRUE)
tax <- read.table(file = taxonomy_file, sep = '\t', header = TRUE)
merged <- merge(otu_table, tax, by.x = c("OTUID"), by.y = c("OTUID"))
write.table(merged, file = "C:/Users/katmu/Dropbox/Valdivia Lab/Projects/Clinical Isolates/Data/Data_for_analysis/Community_Analysis/second_biom/2020-10-16_update/combined_otu_tax.txt", sep = '\t', col.names = TRUE, row.names = FALSE)
```
The resulting file was then used to create the otu and taxonomy files used in later steps. For ASV, I copied the OTU and count data into a new csv file. For taxonomy, I copied the OTU and taxon data into a new csv file. The taxon data was then split into Kindom, Phylum, etc. using the text-to-columns option in Excel.

Load files into phyloseq
```{r}
otu_matrix_file <- "C:/Users/katmu/Dropbox/Valdivia Lab/Projects/Clinical Isolates/Data/Data_for_analysis/Community_Analysis/second_biom/2020-10-16_update/otu-matrix.csv"
taxonomy_matrix_file <- "C:/Users/katmu/Dropbox/Valdivia Lab/Projects/Clinical Isolates/Data/Data_for_analysis/Community_Analysis/second_biom/2020-10-16_update/taxonomy-matrix.csv"
map_file <- "C:/Users/katmu/Dropbox/Valdivia Lab/Projects/Clinical Isolates/Data/Data_for_analysis/Community_Analysis/second_biom/sample-metadata.txt"

otu_matrix <- read.csv(otu_matrix_file, row.names = 1)
otu_matrix <- as.matrix(otu_matrix)

taxonomy_matrix <- read.csv(taxonomy_matrix_file, row.names = 1)
taxonomy_matrix <- as.matrix(taxonomy_matrix)

metadata <- read_delim(map_file, "\t", escape_double = FALSE, trim_ws = TRUE)
meta_df <- metadata %>% as.data.frame()
row.names(meta_df) <- metadata$SampleID
```

Import as phyloseq objects and merge into one
```{r}
otu <- otu_table(otu_matrix, taxa_are_rows = TRUE)
tax <- tax_table(taxonomy_matrix)
meta <- sample_data(meta_df)

physeq <- phyloseq(otu, tax, meta)
physeq
```

Set up subsets for analysis
```{r}
verruco_percent <- "C:/Users/katmu/Dropbox/Valdivia Lab/Projects/Clinical Isolates/Data/Data_for_analysis/Community_Analysis/second_biom/2020-10-16_update/verruco_percent.xlsx"

isolates <- read_excel(verruco_percent)
samples_with_isolates <- isolates$Isolate

isolate_subset <- subset_samples(physeq, SampleID %in% samples_with_isolates)

#Convert abundance counts to percentages. Provided by Jay.
isolate_subset_perc <- transform_sample_counts(isolate_subset, function(x) 100 * x/sum(x))

baseline <- subset_samples(isolate_subset_perc, Visit_number == 1)
endpoint <- subset_samples(isolate_subset_perc, Visit_number == 5)

control <- subset_samples(baseline, Treatment == "control")
base_obese <- subset_samples(baseline, Treatment != "control")
end_obese <- subset_samples(endpoint, Treatment != "control")
```

Count how many samples are in our categories of interest
```{r}
length(sample_names(control))
length(sample_names(base_obese))
length(sample_names(end_obese))
```

Plot top 20 OTUs and color by family. Provided by Jay.
```{r}
Calc.Top20 <- function(subset, graphtitle) {
  top_otus <- names(sort(taxa_sums(subset), decreasing = TRUE))[1:20]
  subset_top20 <- prune_taxa(top_otus, subset)
  barplot <- plot_bar(subset_top20, x = "Patient", fill = "Phylum") +
    geom_bar(stat = "identity", position = "stack", size = 0) +
    labs(title = graphtitle)
  
  return(barplot)
}

control_plot <- Calc.Top20(control, "Controls")
base_obese_plot <- Calc.Top20(base_obese, "Base Obese")
end_obese_plot <- Calc.Top20(end_obese, "End Obese")

plot_grid(control_plot, base_obese_plot, end_obese_plot, labels = c('A', 'B', 'C'))
```
