---
title: "R24-16S"
author: "Katherine Mueller"
date: "10/23/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(phyloseq)
library(readr)
library(readxl)
library(dplyr)
```

Merge ASV count and taxonomy files
```{r}
otu_file <- "C:/Users/katmu/Dropbox/Valdivia Lab/Projects/Clinical Isolates/Data/Data_for_analysis/Community_Analysis/second_biom/2020-10-16_update/otu-table.txt"
taxonomy_file <- "C:/Users/katmu/Dropbox/Valdivia Lab/Projects/Clinical Isolates/Data/Data_for_analysis/Community_Analysis/second_biom/2020-10-16_update/taxonomy.tsv"

otu_table <- read.table(file = biom_file, header = TRUE)
tax <- read.table(file = taxonomy_file, sep = '\t', header = TRUE)
merged <- merge(otu_table, tax, by.x = c("OTUID"), by.y = c("OTUID"))
write.table(merged, file = "C:/Users/katmu/Dropbox/Valdivia Lab/Projects/Clinical Isolates/Data/Data_for_analysis/Community_Analysis/second_biom/2020-10-16_update/combined_otu_tax.txt", sep = '\t', col.names = TRUE, row.names = FALSE)
```
The resulting file was then used to create the otu and taxonomy files used in later steps. For ASV, I copied the OTU and count data into a new csv file. For taxonomy, I copied the OTU and taxon data into a new csv file. The taxon data was then split into Kindom, Phylum, etc. using the text-to-columns option in Excel.

Load files into phyloseq
```{r}
otu_matrix_file <- "C:/Users/katmu/Dropbox/Valdivia Lab/Projects/Clinical Isolates/Data/Data_for_analysis/Community_Analysis/second_biom/2020-10-16_update/otu-matrix.csv"
taxonomy_matrix_file <- "C:/Users/katmu/Dropbox/Valdivia Lab/Projects/Clinical Isolates/Data/Data_for_analysis/Community_Analysis/second_biom/2020-10-16_update/taxonomy-matrix.csv"
map_file <- "C:/Users/katmu/Dropbox/Valdivia Lab/Projects/Clinical Isolates/Data/Data_for_analysis/Community_Analysis/second_biom/sample-metadata.txt"

otu_matrix <- read.csv(otu_matrix_file, row.names = 1)
otu_matrix <- as.matrix(otu_matrix)

taxonomy_matrix <- read.csv(taxonomy_matrix_file, row.names = 1)
taxonomy_matrix <- as.matrix(taxonomy_matrix)

metadata <- read_delim(map_file, "\t", escape_double = FALSE, trim_ws = TRUE)
meta_df <- metadata %>% select(-SampleID) %>% as.data.frame()
row.names(meta_df) <- metadata$SampleID
```

Import as phyloseq objects and merge into one
```{r}
otu <- otu_table(otu_matrix, taxa_are_rows = TRUE)
tax <- tax_table(taxonomy_matrix)
meta <- sample_data(meta_df)

physeq <- phyloseq(otu, tax, meta)
physeq
```

Set up subsets for analysis
```{r}
verruco_percent <- "C:/Users/katmu/Dropbox/Valdivia Lab/Projects/Clinical Isolates/Data/Data_for_analysis/Community_Analysis/second_biom/2020-10-16_update/verruco_percent.xlsx"

isolates <- read_excel(verruco_percent)
samples_with_isolates <- isolates$Isolate

isolate_subset <- subset_samples(merged_phyloseq, patient %in% samples_with_isolates)

baseline <- subset_samples(isolate_subset, visit == 1)
endpoint <- subset_samples(isolate_subset, visit == 5)
```

Plot top 20 OTUs and color by family. Provided by Jay.
```{r}

```

