---
title: "Bubble Graphs"
author: "Katherine Mueller"
date: "4/23/2021"
output: html_document
---
##Generation of Bubble Graphs for R24 sample series
Bubble graph code was generated by Lauren Davey for use in Figure 8 of the Akkermansia Collection paper. We reuse it here to generate a similar graph for the full R24 data set.

##Setup
#Load Libraries
```{r}
library(ggplot2)
library(dplyr)
library(readr)
library(phyloseq)
library(tidyr)
library(cowplot)
```

#Define Paths
```{r}
phylogroups.rds = "../../Data/Data_for_analysis/Community_Analysis/full_R24/r24_phylogroups.rds"
out.dir = "../../Data/Data_for_analysis/Community_Analysis/full_R24"
```

#Load and Check Phyloseq Object
```{r}
phylogroups.ps = read_rds(phylogroups.rds)
print(phylogroups.ps)
```

```{r}
sample_variables(phylogroups.ps)
```

##Generate Proper Dataframe
Lauren's code for making bubble graphs requires a dataframe titled b8 with columns for PID, Akk abundance, clade, and visit

```{r}
#Pull metadata from the phyloseq object
meta <- sample_data(phylogroups.ps)

#Combine the separate phylogroup abundance and presence columns into one each
b8 <- data.frame(AmI = meta$AmI_abund, AmII = meta$AmII_abund, AmIV = meta$AmIV_abund,
                              Patient_ID = meta$ind_id, Time = meta$visit) %>%
  gather(Clade, Relative_Akkermansia_Abundance, AmI:AmIV)
```


##Generate Bubble Graph
#Set ggplot theme 
```{r}
my.theme = theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                 panel.background = element_blank(), axis.line = element_line(colour = "black"), plot.title=element_text(size=25), 
                 axis.title.x=element_text(size=12, face = "bold"), axis.title.y=element_text(size=12, face = "bold"), legend.text=element_text(size=12),
                 axis.text.x=element_text(size=12), axis.text.y=element_text(size=12), 
                 legend.title=element_text(size=12, face="bold"), legend.key=element_blank())


#set colour scheme
#Use scale colour manual to use these custom colours
cols <- c("AmI" = "aquamarine3", "AmII" = "mediumpurple3", "AmIV" = "steelblue2", "Unknown" = "grey25")
```

#Change sequence counts to percent abundance
```{r}
b8$RelPer <- 100*b8$Relative_Akkermansia_Abundance
```

#Filter set to ease of viewing
```{r}
#Filter for just patients who did the full sample series
b8 <- b8 %>%
  filter(Patient_ID %in% c(5, 9, 11, 27, 33, 37, 38, 49, 50, 51, 124, 132, 133, 135, 137, 146, 158, 160, 161, 181, 191, 192, 195, 196, 198,
                           200, 201, 203, 204, 207, 212, 213, 214, 216, 217, 218, 219, 228, 232, 234, 235, 236, 237, 239, 242, 243, 244, 246,
                           248, 250, 251, 254, 255, 259, 263, 264, 271, 272, 273, 280))

#Order the dataset so that samples group by patient
attach(b8)
b8 <- b8[order(Patient_ID),]
detach(b8)

#Re-apply abundance filter so that the graph won't show color for samples with no akk
b8 <- b8 %>% filter(RelPer > 0.01)

#The dataset is still too big for one graph, so I need to divide it up
b8$index <- 1:nrow(b8)
b8 <- b8 %>%
  mutate(graphgroup = if_else(index <= 120, "low", "high"))
```


#Generate bubble graph
Adjust size breaks as needed for your data and change to shape  
```{r}
#Plot with filled circles
#tiff("bubble_fullset_perlog.tiff", units="in", width=8.75, height=8.25, res=300)
ggplot(b8, aes(x = as.factor(Time), y = Patient_ID, col=Clade, shape=Isolate)) +
  geom_point(aes(size = RelPer), alpha=0.5, shape = 19) + facet_wrap(~graphgroup, scales = "free") +
  scale_size(breaks = c(0.01, 0.1, 1, 10, 20),range = c(2,15)) + my.theme + scale_y_discrete(limits=rev) + xlab("Time (months)") +
  ylab("Patient ID") + labs(size = "Akkermansia 16S rRNA Abundance (%)", col = "Phylogroup Compositon") + scale_colour_manual(values = cols)
#dev.off()

#Plot with empty circles
#tiff("bubble_Feb6_perlog.tiff", units="in", width=8.75, height=7.25, res=300)

empty.bubbles <- ggplot(b8, aes(x = as.factor(Time), y = Patient_ID, col=Clade, shape=Isolate)) +
  geom_point(aes(size = RelPer), alpha=0.5, shape = 21, stroke=1.5) +
  scale_size(breaks = c(0, 0.01, 0.1, 10, 20, 30),range = c(2,20)) + my.theme + scale_y_discrete(limits=rev) + xlab("Time (months)") +
  ylab("Patient ID") + labs(size = "Akkermansia Relative Abundance (%)") + scale_colour_manual(values = cols)
#dev.off()
```
